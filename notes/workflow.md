# Workflow to make a run

## Pre-processing
- If aliases are not working, you will have to go to the home directory to source the `.bashrc.sh` file first. 
- go to /global/cfs/cdirs/m3195/ascot/ascot5/runs using the alias `toruns`
- You can find the run such that you want it to the parent of the current run, e.g. group_go_7001
- There will be two files related to group_go_7001, one is a python file and one is an h5 file. The python script is used to generate the h5 script. e.g. group_go_7001.py and group_go_7001.h5
- Then you go copy the python file to its child, e.g. cp group_go_7001.py group_go_7002.py
- Make the necessary changes that you want to test in the new python files. **Importantly, always change the output name of the h5 file to the corresponding run numer, otherwise it would overwrite the parent h5 file** 
- Double check if some of the important changes are made using `diff group_go_7001.py group_go_7002.py`. 
- Run the python script to generate the h5 file by doing the command: `python group_go_7002.py init` 
- Check if the new file is generated by doing a `ls -ltr group_go_7002.h5`
- In the same directory, copy the parent perlmutter.sh file to the child one. In our example, we should use: `cp perlmutter_7001.sh perlmutter_7002.sh`
- Modify the child perlmutter_7002.sh file. Usually we need to modify the following parameters: 
    - nodes
    - nstacks
    - time 
    - **All the run numbers** i.e. change all the 7001 to 7002. 
    
    Remember to also save all the changes to the excel sheet. 
- Make sure all the appropriate changes are made using `diff perlmutter_7001.sh perlmutter_7002.sh` 
- Submit the job using `sbatch perlmutter_7002.sh`
- Use command: `sqs` to check the submit time of the job, if the job has started and what time the job has been started. 

## Post-processing
- Check that the job has indeed finished. Do this by going to runs: `toruns` and do `mycputime jobID`, e.g. `mycputime 10229215`. 
- Knowing that the job is run, we go to the actual output file by doing `tooutput`
- Find that the output file is indeed in there: `ls -ltr`. You will see the most recent directory be at the bottom. It will be called `ascot_work_jobID`, e.g. `ascot_work_10229215`. This directory is created by the run_script, which is `perlmutter_7002.sh`
- cd into this directory, and see the files. The first two will be ones we copied for safty purposes. The last one is the actual output and it should be called `ascot_jobID.h5`, e.g. `ascot_10229215.h5`. 
- Now we go to the place where sscott hosts all his python scrips. The alias for this is `tmp`. **I will potentially be doing some work by modifying these codes, but we don't want to accidentally delete some of the python script, we do all out work in the runs directory**
- Because the above reason, we will do our processing in the runs directory. So we go `toruns`. 
- The script we want to run is called `pnp_losses.py`. But we have to speficy where it is so we use yet another alias: `python $dir_mypython/pnp_losses.py`.
    - It will ask for the name of the ascot output file, which will just be `ascot_jobID.h5`, e.g. `ascot_10229215.h5`. 
    - This post procesor doesn't really do much and what I need to do will require more than this to get something useful. 
    - The `pnp_losses.py` might not find the output file `ascot_jobID.h5`. In this case, we will need to do alias `copy_to_runs jobID`
- The output result to appear in the same directory, the runs directory. It will be called `ascot_jobID_pnp_losses.pdf`. You can view it in `gv ascot_jobID_pnp_losses.pdf`
